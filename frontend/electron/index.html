<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prism Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Basic Top Bar */
        .top-bar {
            height: 50px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 12px;
            -webkit-app-region: drag;
        }

        .top-bar * {
            -webkit-app-region: no-drag;
        }

        .browser-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-right: 20px;
            margin-left: 80px; /* Move away from traffic lights */
        }

        .nav-buttons {
            display: flex;
            gap: 4px;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
        }

        .nav-btn:hover {
            background: #f0f0f0;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .address-container {
            flex: 1;
            max-width: 600px;
        }

        .address-input {
            width: 100%;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0 12px;
            font-size: 14px;
            background: #fff;
        }

        .address-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .tab-controls {
            display: flex;
            gap: 4px;
        }

        .tab-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        /* Tab System */
        .tab-bar {
            height: 40px;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 4px;
            overflow-x: auto;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e0e0e0;
            border: 1px solid #ccc;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            min-width: 120px;
            max-width: 200px;
            font-size: 14px;
            color: #666;
        }

        .tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
            color: #333;
        }

        .tab-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            width: 16px;
            height: 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px;
            color: #999;
            border-radius: 2px;
        }

        .tab-close:hover {
            background: #ff6b6b;
            color: white;
        }

        .tab-new {
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            background: #e0e0e0;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            margin-left: 4px;
        }

        .tab-new:hover {
            background: #d0d0d0;
            color: #333;
        }

        .web-content {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #webviewContainer {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }

        webview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .home-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            z-index: 100;
        }

        .home-page h1 {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .home-page p {
            font-size: 18px;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .home-page .search-box {
            width: 500px;
            height: 50px;
            border: none;
            border-radius: 25px;
            padding: 0 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            outline: none;
            z-index: 1000;
            position: relative;
        }

        .home-page .search-box:focus {
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Basic Top Bar -->
        <div class="top-bar">
            <div class="browser-name">Prism Browser</div>
            
            <div class="nav-buttons">
                <button class="nav-btn" id="backBtn">←</button>
                <button class="nav-btn" id="forwardBtn">→</button>
                <button class="nav-btn" id="refreshBtn">↻</button>
            </div>
            
            <div class="address-container">
                <input type="text" class="address-input" id="addressInput" placeholder="Search or enter URL...">
            </div>
            
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar" id="tabBar">
            <!-- Tabs will be added here dynamically -->
        </div>

        <!-- Web Content -->
        <div class="web-content">
            <div class="home-page" id="homePage">
                <h1>Prism Browser</h1>
                <p>Search the web with Firefox engine</p>
                <input type="text" class="search-box" id="homeSearchBox" placeholder="Search or enter URL...">
            </div>
            <div id="webviewContainer">
                <!-- Webviews will be added here dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Browser State
        let tabs = [];
        let activeTabId = null;

        // DOM Elements
        const homePage = document.getElementById('homePage');
        const homeSearchBox = document.getElementById('homeSearchBox');
        const addressInput = document.getElementById('addressInput');
        const backBtn = document.getElementById('backBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const tabBar = document.getElementById('tabBar');
        const webviewContainer = document.getElementById('webviewContainer');

        // Initialize
        function init() {
            createNewTab();
            setupEventListeners();
        }

        // Create new tab
        function createNewTab(url = null) {
            const tabId = Date.now().toString();
            const tab = {
                id: tabId,
                url: url || 'home',
                title: 'New Tab',
                isLoading: false,
                webview: null
            };
            
            tabs.push(tab);
            activeTabId = tabId;
            
            // Create webview for this tab
            createWebviewForTab(tab);
            
            // Update tab display
            updateTabDisplay();
            
            // Show home page
            showHomePage();
        }

        // Create webview for tab
        function createWebviewForTab(tab) {
            const webview = document.createElement('webview');
            webview.id = `webview-${tab.id}`;
            webview.partition = `persist:tab-${tab.id}`;
            webview.allowpopups = true;
            webview.webpreferences = 'contextIsolation=no, nodeIntegration=yes';
            webview.style.display = 'none';
            webview.style.width = '100%';
            webview.style.height = '100%';
            
            // Add event listeners
            webview.addEventListener('did-start-loading', () => {
                tab.isLoading = true;
                updateTabDisplay();
            });
            
            webview.addEventListener('did-stop-loading', () => {
                tab.isLoading = false;
                tab.title = webview.getTitle() || 'Untitled';
                tab.url = webview.getURL();
                updateTabDisplay();
                updateAddressBar();
            });
            
            webview.addEventListener('did-navigate', (e) => {
                tab.url = e.url;
                updateAddressBar();
            });
            
            webview.addEventListener('did-navigate-in-page', (e) => {
                tab.url = e.url;
                updateAddressBar();
            });
            
            webviewContainer.appendChild(webview);
            tab.webview = webview;
        }

        // Update tab display
        function updateTabDisplay() {
            tabBar.innerHTML = '';
            
            tabs.forEach(tab => {
                const tabElement = document.createElement('div');
                tabElement.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
                tabElement.innerHTML = `
                    <span class="tab-title">${tab.title}</span>
                    <button class="tab-close" onclick="closeTab('${tab.id}')">×</button>
                `;
                
                tabElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-close')) return;
                    switchToTab(tab.id);
                });
                
                tabBar.appendChild(tabElement);
            });
            
            // Add new tab button at the end
            const newTabButton = document.createElement('div');
            newTabButton.className = 'tab-new';
            newTabButton.innerHTML = '+';
            newTabButton.addEventListener('click', () => {
                createNewTab();
            });
            tabBar.appendChild(newTabButton);
        }

        // Switch to tab
        function switchToTab(tabId) {
            activeTabId = tabId;
            const tab = tabs.find(t => t.id === tabId);
            
            if (tab) {
                // Hide all webviews
                tabs.forEach(t => {
                    if (t.webview) {
                        t.webview.style.display = 'none';
                    }
                });
                
                if (tab.url === 'home') {
                    showHomePage();
                } else {
                    hideHomePage();
                    if (tab.webview) {
                        tab.webview.style.display = 'flex';
                    }
                }
                updateAddressBar();
            }
            
            updateTabDisplay();
        }

        // Update address bar
        function updateAddressBar() {
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab) {
                addressInput.value = tab.url === 'home' ? '' : tab.url;
            }
        }

        // Close tab
        function closeTab(tabId) {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;
            
            const tab = tabs[tabIndex];
            
            // Remove webview from DOM
            if (tab.webview) {
                tab.webview.remove();
            }
            
            tabs.splice(tabIndex, 1);
            
            // If we closed the active tab, switch to another tab
            if (activeTabId === tabId) {
                if (tabs.length > 0) {
                    activeTabId = tabs[Math.max(0, tabIndex - 1)].id;
                    switchToTab(activeTabId);
                } else {
                    // No tabs left, create a new one
                    createNewTab();
                }
            } else {
                updateTabDisplay();
            }
        }

        // Show home page
        function showHomePage() {
            homePage.style.display = 'flex';
            // Hide all webviews
            tabs.forEach(t => {
                if (t.webview) {
                    t.webview.style.display = 'none';
                }
            });
            addressInput.value = '';
        }

        // Hide home page and show webview
        function hideHomePage() {
            homePage.style.display = 'none';
        }

        // Load URL with Firefox engine
        async function loadWithFirefoxEngine(url) {
            try {
                const tab = tabs.find(t => t.id === activeTabId);
                if (!tab || !tab.webview) return;
                
                // Hide home page and show webview
                hideHomePage();
                tab.webview.style.display = 'flex';
                
                // Format URL properly
                let formattedUrl = url;
                if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('file://')) {
                    // Check if it looks like a domain
                    if (url.includes('.') && !url.includes(' ')) {
                        formattedUrl = 'https://' + url;
                    } else {
                        // Treat as search query
                        formattedUrl = 'https://www.google.com/search?q=' + encodeURIComponent(url);
                    }
                }
                
                console.log('Loading URL:', formattedUrl);
                
                // Update tab URL immediately
                tab.url = formattedUrl;
                updateAddressBar();
                
                // Try backend first, fallback to direct loading
                try {
                    const response = await fetch('http://localhost:8000/api/engine/navigate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: formattedUrl,
                            engine: 'firefox'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(data.content)}`;
                        tab.webview.src = dataUrl;
                        
                        // Update tab title
                        tab.title = data.title || 'Firefox Page';
                        updateTabDisplay();
                    } else {
                        console.error('Failed to load with Firefox engine:', response.statusText);
                        // Fallback to direct webview loading
                        tab.webview.src = formattedUrl;
                    }
                } catch (fetchError) {
                    console.error('Backend fetch error:', fetchError);
                    // Fallback to direct webview loading
                    tab.webview.src = formattedUrl;
                }
            } catch (error) {
                console.error('Error loading with Firefox engine:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Home page search box
            homeSearchBox.addEventListener('keypress', (e) => {
                console.log('Home search box keypress:', e.key);
                if (e.key === 'Enter') {
                    const url = homeSearchBox.value.trim();
                    console.log('Home search URL:', url);
                    if (url) {
                        loadWithFirefoxEngine(url);
                    }
                }
            });

            // Also add input event for debugging
            homeSearchBox.addEventListener('input', (e) => {
                console.log('Home search box input:', e.target.value);
            });

            // Address bar
            addressInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const url = addressInput.value.trim();
                    if (url) {
                        loadWithFirefoxEngine(url);
                    }
                }
            });

            // Navigation buttons
            backBtn.addEventListener('click', () => {
                const tab = tabs.find(t => t.id === activeTabId);
                if (tab && tab.webview && tab.webview.canGoBack()) {
                    tab.webview.goBack();
                }
            });

            forwardBtn.addEventListener('click', () => {
                const tab = tabs.find(t => t.id === activeTabId);
                if (tab && tab.webview && tab.webview.canGoForward()) {
                    tab.webview.goForward();
                }
            });

            refreshBtn.addEventListener('click', () => {
                const tab = tabs.find(t => t.id === activeTabId);
                if (tab && tab.webview && tab.webview.style.display !== 'none') {
                    tab.webview.reload();
                } else {
                    showHomePage();
                }
            });


            // Update navigation button states periodically
            setInterval(updateNavButtons, 1000);
        }

        // Update navigation button states
        function updateNavButtons() {
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab && tab.webview) {
                backBtn.disabled = !tab.webview.canGoBack();
                forwardBtn.disabled = !tab.webview.canGoForward();
            } else {
                backBtn.disabled = true;
                forwardBtn.disabled = true;
            }
        }

        // Initialize the app
        init();
    </script>
</body>
</html>